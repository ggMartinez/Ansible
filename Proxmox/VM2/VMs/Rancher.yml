  - name: Set Variables
    set_fact:
      vmName: K8s---Rancher

  - name: Create Rancher VM
    community.general.proxmox_kvm:
      api_user: "{{ proxmoxUser }}"
      api_password: "{{ proxmoxPassword }}"
      api_host: "{{ proxmoxIP }}"
      clone: "{{ proxmoxCentosTemplate }}"
      name: "{{ vmName }}"
      proxmox_default_behavior: "no_defaults"
      full: no
    register: vmCreated

  - name: Wait VM to be created
    shell: sleep 10
    when : vmCreated.changed

  - name: Update Rancher VM Settings
    proxmox_kvm:
      api_user: "{{ proxmoxUser }}"
      api_password: "{{ proxmoxPassword }}"
      api_host: "{{ proxmoxIP }}"
      name: "{{ vmName }}"
      node: "{{ proxmoxNode }}"
      cores: 2
      memory: 2048
      nameservers: "192.168.1.254"
      searchdomains: "ggmartinez.duckdns.org"
      ipconfig:
        ipconfig0: 'ip=192.168.1.50/24,gw=192.168.1.1'
      update: true
  
  - name: Add disk for /var/lib/rancher to Rancher VM
    proxmox_disk:
      api_user: "{{ proxmoxUser }}"
      api_password: "{{ proxmoxPassword }}"
      api_host: "{{ proxmoxIP }}"
      vmid: "{{ vmName }}"
      disk: scsi1
      format: qcow2
      storage: local
      size: 10
      create: forced
      state: present

  - name: Add disk for /var/lib/kubelet/pods to Rancher VM
    proxmox_disk:
      api_user: "{{ proxmoxUser }}"
      api_password: "{{ proxmoxPassword }}"
      api_host: "{{ proxmoxIP }}"
      vmid: "{{ vmName }}"
      disk: scsi1
      format: qcow2
      storage: local
      size: 10
      create: forced
      state: present